name: Release

on:
  push:
    tags:
      - "v*.*.*"   # Trigger bei Tags wie v1.2.0, v2.0.0 etc.

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Extract version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF_NAME#v}" >> $GITHUB_OUTPUT

      - name: Update version in manifest.json
        run: |
          jq --arg v "${{ steps.version.outputs.VERSION }}" \
            '.version = $v' manifest.json > manifest.tmp.json
          mv manifest.tmp.json manifest.json

      - name: Build XPI
        run: |
          zip -r keyword-highlighter-${{ github.ref_name }}.xpi \
            manifest.json bootstrap.js prefs.js chrome.manifest \
            content/ locale/
          echo "XPI_NAME=keyword-highlighter-${{ github.ref_name }}.xpi" >> $GITHUB_ENV

      - name: Compute SHA256
        id: sha
        run: |
          SHA=$(sha256sum "$XPI_NAME" | cut -d' ' -f1)
          echo "SHA256=$SHA" >> $GITHUB_OUTPUT
          echo "SHA256 of XPI: $SHA"

      - name: Update updates.json
        run: |
          jq --arg version "${{ steps.version.outputs.VERSION }}" \
             --arg url "https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/$XPI_NAME" \
             --arg sha "sha256:${{ steps.sha.outputs.SHA256 }}" \
            '.addons["keyword-highlighter@zotero-plugin"].updates = [{
              version: $version,
              update_link: $url,
              update_hash: $sha,
              applications: { zotero: { strict_min_version: "7.0" } }
            }]' updates.json > updates.tmp.json
          mv updates.tmp.json updates.json

      - name: Commit updated updates.json
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add updates.json manifest.json
          git commit -m "chore: bump version to ${{ steps.version.outputs.VERSION }}"
          git push origin HEAD:main

      - name: Extract changelog for this version
        id: changelog
        run: |
          # Extrahiert den Abschnitt der aktuellen Version aus CHANGELOG.md
          if [ -f CHANGELOG.md ]; then
            NOTES=$(awk "/^## ${{ github.ref_name }}/{found=1; next} found && /^## /{exit} found{print}" CHANGELOG.md)
            echo "NOTES<<EOF" >> $GITHUB_OUTPUT
            echo "$NOTES" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "NOTES=Release ${{ github.ref_name }}" >> $GITHUB_OUTPUT
          fi

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: "Keyword Highlighter ${{ github.ref_name }}"
          body: ${{ steps.changelog.outputs.NOTES }}
          files: ${{ env.XPI_NAME }}
          draft: false
          prerelease: false
